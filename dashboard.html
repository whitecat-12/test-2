<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Guru - Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" 
    onload="renderMathInElement(document.body);"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-8 text-teal-700">Dashboard Guru - Upload Soal</h1>

    <!-- Form input soal -->
    <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
      <form id="soalForm" class="space-y-4">
        <input type="hidden" id="soalId">

        <!-- Mata Pelajaran Dinamis -->
        <div>
          <label class="block font-semibold mb-1">Mata Pelajaran:</label>
          <div class="flex gap-2 mb-2">
            <input type="text" id="mapelInput" class="w-full border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" placeholder="Ketik nama mata pelajaran">
            <button type="button" id="tambahMapel" class="bg-teal-500 text-white px-3 py-2 rounded-lg hover:bg-teal-600 transition">+</button>
          </div>
          <div id="daftarMapel" class="flex flex-wrap gap-2"></div>
        </div>

        <div>
          <label class="block font-semibold mb-1">Pertanyaan:</label>
          <textarea id="pertanyaan" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" placeholder="Gunakan $...$ untuk inline atau $$...$$ untuk display math" required></textarea>
        </div>

        <div>
          <label class="block font-semibold mb-1">Opsi Jawaban:</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <input type="text" id="opsiA" placeholder="A" class="border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
            <input type="text" id="opsiB" placeholder="B" class="border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
            <input type="text" id="opsiC" placeholder="C" class="border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
            <input type="text" id="opsiD" placeholder="D" class="border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
          </div>
        </div>

        <div>
          <label class="block font-semibold mb-1">Jawaban Benar:</label>
          <select id="jawaban" class="w-full border p-2 rounded-lg focus:ring-1 focus:ring-teal-400">
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
          </select>
        </div>

        <div>
          <label class="block font-semibold mb-1">Penjelasan:</label>
          <textarea id="penjelasan" class="w-full border p-3 rounded-lg focus:ring-1 focus:ring-teal-400" placeholder="Gunakan $...$ untuk inline atau $$...$$ untuk display math"></textarea>
        </div>

        <button type="submit" class="w-full bg-teal-600 text-white p-3 rounded-lg hover:bg-teal-700 transition font-semibold flex justify-center items-center gap-2">
          <i class="fa-solid fa-floppy-disk"></i> Simpan Soal
        </button>
      </form>
    </div>

    <!-- Daftar soal -->
    <div id="daftarSoal" class="space-y-6"></div>

    <button id="logoutBtn" class="mt-6 w-full bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition font-semibold flex justify-center items-center gap-2">
      <i class="fa-solid fa-right-from-bracket"></i> Logout
    </button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJ5I8k2MzAyDLt9fUcXHRNtRVjKB_ETLY",
      authDomain: "projectid-81104.firebaseapp.com",
      projectId: "projectid-81104",
      storageBucket: "projectid-81104.firebasestorage.app",
      messagingSenderId: "554913260457",
      appId: "1:554913260457:web:bf988867ebfd902c651ab8",
      measurementId: "G-8WFHQW5WGN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const soalForm = document.getElementById('soalForm');
    const daftarSoal = document.getElementById('daftarSoal');
    const logoutBtn = document.getElementById('logoutBtn');

    const mapelInput = document.getElementById("mapelInput");
    const tambahMapelBtn = document.getElementById("tambahMapel");
    const daftarMapelDiv = document.getElementById("daftarMapel");

    let daftarMapel = [];

    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "login.html";
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    // Tambah mata pelajaran
    tambahMapelBtn.addEventListener("click", () => {
      const namaMapel = mapelInput.value.trim();
      if (!namaMapel) return;
      if (daftarMapel.includes(namaMapel)) return alert("Mata pelajaran sudah ada!");

      daftarMapel.push(namaMapel);

      const span = document.createElement("span");
      span.className = "bg-teal-100 text-teal-700 px-3 py-1 rounded-full flex items-center gap-2";
      span.innerHTML = `${namaMapel} <i class="fa-solid fa-xmark cursor-pointer"></i>`;
      
      span.querySelector("i").addEventListener("click", () => {
        daftarMapel = daftarMapel.filter(m => m !== namaMapel);
        daftarMapelDiv.removeChild(span);
      });

      daftarMapelDiv.appendChild(span);
      mapelInput.value = "";
    });

    soalForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const soalId = document.getElementById("soalId").value;

      if (daftarMapel.length === 0) {
        alert("Silakan tambahkan minimal satu mata pelajaran!");
        return;
      }

      // ambil mata pelajaran terakhir yang ditambahkan
      const mapel = daftarMapel[daftarMapel.length - 1];

      const soalData = {
        mapel: mapel,
        pertanyaan: document.getElementById("pertanyaan").value,
        opsi: {
          A: document.getElementById("opsiA").value,
          B: document.getElementById("opsiB").value,
          C: document.getElementById("opsiC").value,
          D: document.getElementById("opsiD").value
        },
        jawaban: document.getElementById("jawaban").value,
        penjelasan: document.getElementById("penjelasan").value
      };

      if (soalId) {
        await updateDoc(doc(db, "soal", soalId), soalData);
      } else {
        await addDoc(collection(db, "soal"), soalData);
      }

      soalForm.reset();
      document.getElementById("soalId").value = "";
      loadSoal();
    });

    async function loadSoal() {
      daftarSoal.innerHTML = "";
      const snapshot = await getDocs(collection(db, "soal"));
      const grouped = {};
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (!grouped[data.mapel]) grouped[data.mapel] = [];
        grouped[data.mapel].push({ id: docSnap.id, ...data });
      });

      Object.keys(grouped).forEach(mapel => {
        const container = document.createElement("div");
        container.className = "bg-white rounded-2xl shadow";

        container.innerHTML = `
          <div class="p-4 bg-teal-600 text-white rounded-t-2xl cursor-pointer flex justify-between items-center">
            <h2 class="text-lg font-semibold">${mapel}</h2>
            <i class="fa-solid fa-chevron-down"></i>
          </div>
          <div class="p-4 space-y-4 hidden"></div>
        `;

        const soalList = container.querySelector("div:last-child");

        grouped[mapel].forEach(item => {
          const li = document.createElement("div");
          li.className = "bg-gray-50 p-4 rounded-xl shadow flex flex-col md:flex-row md:justify-between md:items-start gap-4";
          li.innerHTML = `
            <div>
              <p class="font-semibold mb-1 katex-content">${item.pertanyaan}</p>
              <p class="text-gray-600 text-sm mb-2">Jawaban: <span class="font-medium">${item.jawaban}</span></p>
              <p class="text-gray-500 text-sm katex-content">${item.penjelasan || ''}</p>
            </div>
            <div class="flex gap-2">
              <button data-id="${item.id}" class="editBtn bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition flex items-center gap-1">
                <i class="fa-solid fa-pen"></i> Edit
              </button>
              <button data-id="${item.id}" class="deleteBtn bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition flex items-center gap-1">
                <i class="fa-solid fa-trash"></i> Hapus
              </button>
            </div>
          `;
          soalList.appendChild(li);

          renderMathInElement(li, {
            delimiters: [
              {left: "$$", right: "$$", display: true},
              {left: "$", right: "$", display: false}
            ]
          });
        });

        container.querySelector("div:first-child").addEventListener("click", () => {
          soalList.classList.toggle("hidden");
        });

        daftarSoal.appendChild(container);
      });

      document.querySelectorAll(".editBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const docId = btn.dataset.id;
          const docSnap = await getDoc(doc(db, "soal", docId));
          if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById("soalId").value = docId;
            mapelInput.value = data.mapel;
            if (!daftarMapel.includes(data.mapel)) daftarMapel.push(data.mapel);
            document.getElementById("pertanyaan").value = data.pertanyaan;
            document.getElementById("opsiA").value = data.opsi.A;
            document.getElementById("opsiB").value = data.opsi.B;
            document.getElementById("opsiC").value = data.opsi.C;
            document.getElementById("opsiD").value = data.opsi.D;
            document.getElementById("jawaban").value = data.jawaban;
            document.getElementById("penjelasan").value = data.penjelasan;
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });
      });

      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          if (confirm("Yakin ingin menghapus soal ini?")) {
            await deleteDoc(doc(db, "soal", btn.dataset.id));
            loadSoal();
          }
        });
      });
    }

    loadSoal();
  </script>
</body>
</html>
