<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Guru - Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" 
    onload="renderMathInElement(document.body);"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-8 text-teal-700">Dashboard Guru - Upload Soal</h1>

    <!-- Form input soal -->
    <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
      <form id="soalForm" class="space-y-4">
        <input type="hidden" id="soalId">
        <div>
          <label class="block font-semibold mb-1">Pertanyaan:</label>
          <textarea id="pertanyaan" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" placeholder="Gunakan $...$ untuk inline atau $$...$$ untuk display math" required></textarea>
        </div>
        <div>
          <label class="block font-semibold mb-1">Opsi Jawaban:</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <input type="text" id="opsiA" placeholder="A" class="border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
            <input type="text" id="opsiB" placeholder="B" class="border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
            <input type="text" id="opsiC" placeholder="C" class="border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
            <input type="text" id="opsiD" placeholder="D" class="border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
          </div>
        </div>
        <div>
          <label class="block font-semibold mb-1">Jawaban Benar:</label>
          <select id="jawaban" class="w-full border p-2 rounded-lg focus:ring-1 focus:ring-teal-400">
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
          </select>
        </div>
        <div>
          <label class="block font-semibold mb-1">Penjelasan:</label>
          <textarea id="penjelasan" class="w-full border p-3 rounded-lg focus:ring-1 focus:ring-teal-400" placeholder="Gunakan $...$ untuk inline atau $$...$$ untuk display math"></textarea>
        </div>
        <button type="submit" class="w-full bg-teal-600 text-white p-3 rounded-lg hover:bg-teal-700 transition font-semibold flex justify-center items-center gap-2">
          <i class="fa-solid fa-floppy-disk"></i> Simpan Soal
        </button>
      </form>
    </div>

    <!-- Daftar soal -->
    <div id="daftarSoal" class="space-y-4"></div>

    <button id="logoutBtn" class="mt-6 w-full bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition font-semibold flex justify-center items-center gap-2">
      <i class="fa-solid fa-right-from-bracket"></i> Logout
    </button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJ5I8k2MzAyDLt9fUcXHRNtRVjKB_ETLY",
      authDomain: "projectid-81104.firebaseapp.com",
      projectId: "projectid-81104",
      storageBucket: "projectid-81104.firebasestorage.app",
      messagingSenderId: "554913260457",
      appId: "1:554913260457:web:bf988867ebfd902c651ab8",
      measurementId: "G-8WFHQW5WGN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const soalForm = document.getElementById('soalForm');
    const daftarSoal = document.getElementById('daftarSoal');
    const logoutBtn = document.getElementById('logoutBtn');

    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "login.html";
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    soalForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const soalId = document.getElementById("soalId").value;
      const soalData = {
        pertanyaan: document.getElementById("pertanyaan").value,
        opsi: {
          A: document.getElementById("opsiA").value,
          B: document.getElementById("opsiB").value,
          C: document.getElementById("opsiC").value,
          D: document.getElementById("opsiD").value
        },
        jawaban: document.getElementById("jawaban").value,
        penjelasan: document.getElementById("penjelasan").value
      };

      if (soalId) {
        await updateDoc(doc(db, "soal", soalId), soalData);
      } else {
        await addDoc(collection(db, "soal"), soalData);
      }

      soalForm.reset();
      document.getElementById("soalId").value = "";
      loadSoal();
    });

    async function loadSoal() {
      daftarSoal.innerHTML = "";
      const snapshot = await getDocs(collection(db, "soal"));

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const li = document.createElement("div");
        li.className = "bg-white p-5 rounded-2xl shadow hover:shadow-lg transition flex flex-col md:flex-row md:justify-between md:items-start gap-4";

        li.innerHTML = `
          <div>
            <p class="font-semibold mb-1 katex-content">${data.pertanyaan}</p>
            <p class="text-gray-600 text-sm mb-2">Jawaban: <span class="font-medium">${data.jawaban}</span></p>
            <p class="text-gray-500 text-sm katex-content">${data.penjelasan || ''}</p>
          </div>
          <div class="flex gap-2 mt-2 md:mt-0">
            <button data-id="${docSnap.id}" class="editBtn bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition flex items-center gap-1">
              <i class="fa-solid fa-pen"></i> Edit
            </button>
            <button data-id="${docSnap.id}" class="deleteBtn bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition flex items-center gap-1">
              <i class="fa-solid fa-trash"></i> Hapus
            </button>
          </div>
        `;
        daftarSoal.appendChild(li);

        // Render LaTeX
        renderMathInElement(li, {
          delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
          ]
        });
      });

      document.querySelectorAll(".editBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const docId = btn.dataset.id;
          const docSnap = await getDoc(doc(db, "soal", docId));
          if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById("soalId").value = docId;
            document.getElementById("pertanyaan").value = data.pertanyaan;
            document.getElementById("opsiA").value = data.opsi.A;
            document.getElementById("opsiB").value = data.opsi.B;
            document.getElementById("opsiC").value = data.opsi.C;
            document.getElementById("opsiD").value = data.opsi.D;
            document.getElementById("jawaban").value = data.jawaban;
            document.getElementById("penjelasan").value = data.penjelasan;
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });
      });

      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          if (confirm("Yakin ingin menghapus soal ini?")) {
            await deleteDoc(doc(db, "soal", btn.dataset.id));
            loadSoal();
          }
        });
      });
    }

    loadSoal();
  </script>
</body>
</html>
